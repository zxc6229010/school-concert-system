<!doctype html>
<html lang="zh-Hant">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>活動設定（後台）</title>

    <style>
      body {
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
          sans-serif;
        background: #f7f7f8;
        margin: 0;
        padding: 24px;
      }
      .container {
        max-width: 720px;
        margin: auto;
        background: white;
        border-radius: 12px;
        padding: 24px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.06);
      }
      h1 {
        margin-top: 0;
      }
      label {
        display: block;
        font-weight: 600;
        margin-top: 16px;
        margin-bottom: 4px;
      }
      input,
      textarea {
        width: 100%;
        padding: 10px;
        font-size: 16px;
        border-radius: 8px;
        border: 1px solid #d0d0d5;
        box-sizing: border-box;
      }
      textarea {
        min-height: 120px;
        resize: vertical;
      }
      .hint {
        font-size: 13px;
        color: #666;
        margin-top: 4px;
      }
      .topbar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 16px;
      }
      button {
        padding: 8px 14px;
        border-radius: 8px;
        border: 1px solid #ccc;
        background: #fff;
        cursor: pointer;
      }
      button.primary {
        background: #306fdb;
        color: white;
        border: none;
      }
      #status {
        margin-top: 16px;
        color: #555;
      }
    </style>
  </head>

  <body>
    <div class="container">
      <div class="topbar">
        <h1>活動設定</h1>
        <button id="logoutBtn">登出</button>
      </div>

      <form id="eventForm">
        <label>活動標題</label>
        <input id="title" />

        <label>副標題</label>
        <input id="subtitle" />

        <label>活動時間</label>
        <input id="datetime" placeholder="例如：2026/03/20（五）18:30" />

        <label>活動地點</label>
        <input id="location" />

        <label>注意事項</label>
        <textarea id="notice"></textarea>

        <div style="display:flex; gap:10px; align-items:center; margin-top:12px;">
  <button type="button" id="saveBtn" class="primary" disabled>儲存</button>
  <span class="hint" id="saveHint">※ 修改後按儲存，學生頁面會即時更新</span>
</div>
      </form>

      <p id="status">載入中…</p>
    </div>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
      import {
        getAuth,
        GoogleAuthProvider,
        signInWithPopup,
        signOut,
        onAuthStateChanged
      } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
      import {
  getFirestore,
  doc,
  getDoc,
  setDoc,
  serverTimestamp
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

      const firebaseConfig = {
  apiKey: "AIzaSyDu4_bW4_5Sq9ZLESIvBQGWPADak7rDlV4",
  authDomain: "concert-31d86.firebaseapp.com",
  projectId: "concert-31d86",
  storageBucket: "concert-31d86.firebasestorage.app",
  messagingSenderId: "996102236874",
  appId: "1:996102236874:web:819fb5ba4021a7ee08e233",
  measurementId: "G-D6CX39EKLB"
};

      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);

      const statusEl = document.getElementById("status");
      const logoutBtn = document.getElementById("logoutBtn");
      const saveBtn = document.getElementById("saveBtn");
const saveHint = document.getElementById("saveHint");
const eventRef = doc(db, "eventConfig", "current");

      logoutBtn.onclick = () => signOut(auth);

      onAuthStateChanged(auth, async (user) => {
        if (!user) {
          statusEl.textContent = "請先登入";
          await signInWithPopup(auth, new GoogleAuthProvider());
          return;
        }

        statusEl.textContent = "讀取活動資料中…";

        try {
          const ref = doc(db, "eventConfig", "current");
          const snap = await getDoc(ref);

          if (!snap.exists()) {
            statusEl.textContent = "找不到活動資料";
            return;
          }

          const data = snap.data();

          document.getElementById("title").value = data.title ?? "";
          document.getElementById("subtitle").value = data.subtitle ?? "";
          document.getElementById("datetime").value = data.datetime ?? "";
          document.getElementById("location").value = data.location ?? "";
          document.getElementById("notice").value = data.notice ?? "";

          statusEl.textContent = "已載入（尚未儲存）";
          saveBtn.disabled = false;
saveHint.textContent = "※ 修改後按儲存，學生頁面會即時更新";
        } catch (e) {
          console.error(e);
          statusEl.textContent = "讀取失敗（請看 Console）";
        }
      });
    </script>
    saveBtn.onclick = async () => {
  saveBtn.disabled = true;
  saveHint.textContent = "儲存中…";
  statusEl.textContent = "儲存中…";

  try {
    await setDoc(
      eventRef,
      {
        title: document.getElementById("title").value.trim(),
        subtitle: document.getElementById("subtitle").value.trim(),
        datetime: document.getElementById("datetime").value.trim(),
        location: document.getElementById("location").value.trim(),
        notice: document.getElementById("notice").value.trim(),
        updatedAt: serverTimestamp()
      },
      { merge: true }
    );

    statusEl.textContent = "儲存成功 ✅";
    saveHint.textContent = "已儲存。你可以打開學生頁面確認已更新。";
  } catch (e) {
    console.error(e);
    statusEl.textContent = "儲存失敗（請看 Console）";
    saveHint.textContent = "儲存失敗：請確認你是 superAdmin 且 Rules 已發布。";
  } finally {
    saveBtn.disabled = false;
  }
};
  </body>
</html>